# 负载均衡分类
|类别|特点|协议|架构基础|
|-|-|-|-|
|四层负载均衡（TCP）|其特点是在IP负载均衡的基础上基于IP及端口号来进行负载均衡。依据负载均衡SLB中设定的转发策略和规则，报文中的**目标IP地址和端口**，把流量发给对应的ECS实例。<br>|TCP/UDP|四层采用开源软件**LVS（Linux Virtual Server）**+ keepalive。|
|七层负载均衡（HTTP）|对应OSI模型的应用层，基于虚拟URL或者其他应用层信息的负载均衡。依据负载均衡SLB中设定的转发策略和规则，报文中真正有意义的应用层内容，把流量发给对应的ECS实例。|HTTP/HTTPS|Tengine|

|功能|4层CLB|7层CLB|
|-|-|-|
|调度算法<br>CLB支持轮询、加权轮询、一一致性哈西|☑️|不支持一致性哈希|
|健康检查|☑️|☑️|
|会话保持|☑️|☑️|
|高可用|☑️|☑️|
|域名URL妆发<br>支持配置域名和URL转发规则，可用将来自不同域名和URL的请求转发到不同的服务器上。|-|☑️|
|证书管理<br>针对HTTPS协议，提供统一的证书管理服务。证书无需上传到后端服务器，解密处理在CLB进行，降低后端服务器的CPU开销。|-|☑️|
|SNI<br>支持CLB HTTPS监听自持挂载过多个证书，将来自不同访问域名的请求转发至不同的后端服务器组。|-|☑️|
|重定向<br>CLB支持HTTP访问重定向至HTTPS。创建一个HTTPs的监听，创建HTTP监听并配置重定向，添加HTTP监听，并开始监听转发，目的监听HTTP：443.|-|☑️|
|获取真实IP|默认开启|通过HTTP Header:X-Forwarded-For|


* CLB不支持FTP。不支持IDC。
* CLB通过设置虚拟服务地址，将添加的同一个地域的多台ECS实例虚拟成一个高性能和高可用的后端服务池，并根据转发规则，将来自客户端的请求分发给后端服务器中的ECS实例。

## LVS集群 
* LVS集群结构由负载调度器（load balancer）/服务器池（server pool）/共享存储（shared storage）组成。
* LVS集群内的每台LVS都会将所有会话通过**组播报文**同步到该集群内的其他LVS机器上。
### 阿里云优化LVS
* 新增synproxy等攻击TCP标志位DDOS攻击防御功能。
* 采用LVS集群部署方式。
* 优化keepalived性能。
* 新增转发模式FULLNAT，实现LVS-RealServer间跨vlan通讯。

## 入网流量路径
* CLB实例服务端口使用的是四层协议，那么LVS集群内每个节点都会根据CLB实例的策略，将其承载的服务请求按策略直接分发到后端ECS实例。
* CLB实例服务端口使用的是七层HTTP协议，那么LVS集群内每个节点会将其承载的服务请求均分到Tengine集群，Tengine集群内的每个节点再根据CLB策略，将服务请求按策略最终分发到后端ECS服务器。
* CLB实例服务端口使用的是七层HTTPs协议，与上诉HTTP处理类似，差别是在按策略将服务请求最终分发到后端ECS服务钱，先调用Key Server进行证书验证及数据包加解密等前置操作。

# 算法
* 轮询法
* 加权轮询法
* 随机法
* Hash类
* 最小连接法
* 加权最小连接数

# 负载均衡SLB（Server Load Balancer）
## 产品家族
* 应用型负载均衡ALB（Application Load Balancer）：面向HTTP、HTTP和QUIC等应用层负载均衡场景的负载均衡服务，具备超强弹性及大规模应用层流量处理能力。
    * 七层协议，健康检测支持GRPC、TCP和HTTP。
    * HTTP：通过发送HEAD或GET请求模拟浏览器的访问行为来检查服务器应用是否健康。
    * TCP：通过发送SYN握手报文来检测服务器端口是否存活。
    * GRPC：通过POST或者GET请求来检查服务器应用是是否健康。
* 网络型负载均衡NLB（Network Load Balancer）
* 传统型负载均衡CLB（Classic Load Balancer）

# CLB实例
CLB默认检查服务器池中的ECS实例的健康状况，自动隔离异常状态的ECS实例，消除了单台ECS实例的单点故障，提高了应该的整体服务能力。CLB还具备抗DDoS攻击的能力，增强了应用服务的防护能力。

目前CLB实例支持添加ECS、弹性容器实例ECI和弹性网卡作为后端服务器。

**注：无法跨地域。**

CLB通过设置虚拟服务地址，将添加的同一地域的多台ECS实例虚拟成一个高性能和高可用的后端服务池，并根据转发规则，将来自客户端请求分发给后端服务器池中的ECS实例.

## 优势
|优势|说明|
|-|-|
|高可用|采用全冗余设，无单点，支持同城容灾，**不支持跨地域**。根据应用负载进行弹性扩容，在流量波动情况下不中断对外服务。|
|可拓展|可根据业务需求，随时增加或减少后端服务器的数量，扩展应用的服务能力。|
|低成本|相比传统硬件负载均衡，成本可下降60%，私网SLB无流量费。|
|安全|结合云盾，可提供5Gbps的防DDos攻击。|
|高并发|集群支持亿级并发连接，单实例提供千万级并发能力。|

## 容灾
|类型|说明|
|-|-|
|同城容灾（多可用区容灾）|CLB已在个地域部署了多可用区来实现同城容灾。当主可用区出现机房故障或不可用是，CLB仍然有能力在短时间内切换到备可用区恢复服务能力；当主服务器恢复时，CLB同样会自动切换到主可用区。|
|跨地域容灾|用户可以再不同地域下部署CLB实例，并分别挂载相应地域内不同可用区的ECS实例。上层利用云解析智能DNS，将域名解析到不同地域的CLB实例服务地址下，可实现全局CLB。|
## 按规格分类
* **性能保障型**：提供可保障的性能指标。当指标超过限定值时，新建连接请求将被丢弃。
    * 最大连接数Max Connection
    * 每秒新建连接数Connection Per Second (CPS)
    * 每秒查询数QueryPer Second（QPS）
* **性能共享型**：资源时所有实例共享，不保障实例的性能指标。
## 按网络类型分配
* 公网类型的CLB
    * 创建实例时，自动分配公网IP，IP不能解绑。
    * 计费类型为包年包月，只支持按固定宽带计费；计费类型为按量付费是，支持按流量计费和按固定带宽计费。
    
* 私网类型的CLB
    * 通过私网IP对外提供服务。
    * 可配合EIP提供公网负载均衡能力，EIP和CLB可以灵活解绑。
    * EIP加入共享宽带，除了包年包月和按量计费外，还可以使用95宽带峰值计费。
# CLB组成
* **CLB实例**：一个CLB实例时一个运行的负载均衡服务，用来接受流量并将其分配给后端服务器。
    * LoadBalanceId是用于识别用户CLB实例的唯一标识。
    * 要使用负载均衡服务，用户必须创建一个CLB实例，并添加一个监听和两台ECS实例。
    * 如果用户不指定一个容易识别的CLB名称，系统会自行分配一个。
* **监听（Listeners）**：（TCP、UDP、HTTP、HTTPS）监听用来检查客户端请求并将请求转发给后端服务器。服务监听包含了监听端口，负载均衡策略，健康检查等。
* 后端服务器（Backend Servers）：一组接受前端请求的ECS实例

# 监听（Lisnter）
## 服务监听的组成
* 监听端口
* 负载均衡策略
* 健康检查配置
## 访问控制策略配置流程
1.  创建访问控制策略组。
2.  开启访问控制。
3.  关闭访问控制。

* 如果开启白名单或者黑名单，但是访问策略组没有添加任何IP，负载均衡监听会转发所有请求。


# 后端服务器
* 默认服务器组
* 虚拟服务器组：将不同URL等规则转发到不同的后端服务器。不同业务转发到不同的后端服务器的功能。
* 主备服务器组：一个主备服务器组，只包含两台ECS实例，一主一备。只支持四层监听（TCP和UDP协议）

## 后端服务器组限制
* 至少有一台正常运行的ECS实例。
* CLB默认不支持跨地域部署。
* CLB本身不会限制后端ECS实例用什么操作系统，只要用户的两台ECS实例中的应用服务部署是相同的且保证数据的一致性即可。
* 一个CLB实例最多支持添加50个监听，每个监听对应后端ECS实例上的一个应用。
* 用户可以指定后端服务器池内各ECS实例的转发权重，权重越高的ECS实例将被分配到更多的访问请求。
* 如果用户开启了会话保持功能，那么可以造成后端服务器的访问并不是完全相同的，分发请求不均匀。
* CLB服务能力与后端服务器公网带宽无关。
* 如果ECS有公网IP，禁用公网网卡会影响负载均衡。
* 经典网络类型CLB支持专有网络VPC类型后端服务器。
* 后端ECS实例的操作系统可以不同。

## 转发优先级
1.  我们首先判断器是否能够匹配转发规则，如果匹配，则将流量转发到该规则的后端服务器。
2.  若不匹配并且在该监听上设置了虚拟服务器组，那么将流量转发到该虚拟服务组上。
3. 若用户没有在该监听设置虚拟服务器组，即将流量转发到实例级别添加的各后端服务器汇总。
转发规则>虚拟服务器组>后端服务器
# 健康检查
* 针对四层UDP监听，健康检查通过**UDP报文**探测来获取状态信息。
## 健康检查时间窗
* 健康检测间隔
* 响应超时时间
* 检查阈值

### 以下是TCP、HTTP和HTTPS监听建议使用的健康配置检查：
|配置|推荐值|
|----|----|
|响应超时时间|5s|
|健康检查间隔|2s|
|不健康阈值|3s|
|健康阈值|3s|
|||
### 以下是UDP监听建使用的健康检查配置：
|配置|推荐值|
|----|----|
|响应超时时间|10s|
|健康检查间隔|5s|
|不健康阈值|3s|
|健康阈值|3s|
|||

* **健康检查失败时间窗** = 响应超时时间 x 不健康阈值 + 检查间隔 x（不健康阈值 - 1）
    * 检查检查失败时间窗 = 5 x 3 + 2 x (3 - 1) = 19s

* **健康检测成功时间窗** = 健康检测成功响应时间 x 健康阈值 + 间隔检查 x（健康阈值 - 1）

    * 健康检测成功时间窗 = 1 x 3 + 2 x (3 - 1) = 7s

TCP响应时间一般不会超过1s计算时检查成功的返回时间默认1s

## 健康检测状态对请求转发的影响
* 如果目标ECS存在异常，正处于健康检查失败时间窗，而且健康检查还未达到检查失败判定次数，则相应请求还是会被分到该ECS，进而导致前端访问失败。
## 七层健康监测
* Tengine节点服务器根据监听的健康检查配置，向后端ECS的内网IP+健康检查端口+检查。
* 后端收到ECS请求之后，根据服务运行情况，返回HTTP状态码。
* 在响应超时时间内，Tengine节点服务器没有收到后端ECS返回的信息，则认为服务无响应，判定健康检查失败。
* 如果在响应超时时间之内，Tengine节点服务器成功接收到后端ECS返回信息，则将收到的返回信息与配置的状态码比较。如果匹配则判定健康检测成功，反正判定健康检查失败。

# 会话保持
## 概念
开启会话保持后，负载均衡监听会把来自同一个客户端的访问请求分发到同一台后端服务器上。

会话保持开启后可能会导致负载均衡请求不均衡。

## 如何实现
* 四层监听通过源IP实现，同一个源IP发送到同一台后端服务器。
* 七层监听通过Cookie实现：
    * **植入Cookie**：客户端第一次访问是，负载均衡会在返回请求中植入Cookie，即在HTTP/HTTPS响应报文中插入SERVERID，下次客户端携带此Cookie访问，负载均衡将请求定向转发给之前记录到的后端服务器。
    * **重写Cookie**：当负载均衡发现用户自定义Cookie，将会对原来的Cookie进行重写，下次客户端携带此Cookie访问，负载均衡将请求定向转发给之前记录到的后端服务器。
# 证书管理
添加HTTPs监听，用户需要上传服务器证书或者CA证书并选择TLS安全策略。
* 上传证书的格式必须是**PEM**。
* 证书上传到负载均衡后，负载均衡即可管理证书，不需要在后端ECS上绑定证书。
## 证书类型
* Root CA机构办法的证书（CA证书）：只需要上传证书内容，不需要上传私钥。
* 中级机构颁发的证书（服务器证书）：在上传服务器证书内容是，也需要上传证书的私钥。
### 证书上传方式
* API：使用UploadServerCertificate接口一次只能上传一份服务器证书和应对的私钥。
* 控制台

# 综合实践应用
## URL 路径转发
当前端请求同时匹配多条域名策略时，策略的匹配优先级为：精确匹配>小范围通配符匹配>大范围通配符匹配

## 伸缩组与负载均衡
* 一个SLB实例可以绑定多个伸缩组。
* 一个伸缩组也可以同时支持多个SLB实例。
* 必须持有一个或者多个处于运行状态的负载均衡实例。
* 负载均衡实例必须和伸缩组位于**同一地域**。
* 负载均衡实例必须至少配置一个监听并开启健康检查功能。
* 若都为专有网络，则必须处于相同的专有网络下。
* 伸缩组中附加的负载均衡实例个数必须少于伸缩组的配额。
* 当负载均衡实例的网络类型为经典网络，伸缩组的网络类型为专有网络时，如果负载均衡实例的后端服务器组中包含专有网络ECS实例，该ECS实例必须与伸缩组位于同一专有网络。

## 使用ALB灰度发布
* 基于HTTP标头实现灰度发布
* 基于Cookie实现灰度发布
* 基于不同服务器组实现灰度发布
# 运维与故障排查
## CLB与后端服务器功能限制
* 对于四层监听的后端服务器无法访问SLB问题，是由于目前负载均衡不支持同时作为客户端和服务端。
* 不支持通过负载均衡SLB搭建FTP、TFTP等

## 会话保持异常
* 未开启，则相关数据无法持续提交，会丢失大量数据。
* 会话超时，则相关数据超时后无法继续提交，会丢失少量数据。

# 计费
实例费是公网CLB实例公网IP的保留费，私网CLB实例免收实例费。

|按使用流量计费CLB|按固定带宽计费CLB|
|-|-|
|带宽峰值不作为业务承诺，仅作为参考值和带宽上限峰值，当出现资源争抢是，带宽分值可能受到限制。带宽峰值总和不大于5Gbps|带宽峰值作为业务承诺指标，当出现资源争抢是，带宽峰值有保证。实际运行带宽峰值总和不大于50Gbps。|

## CLB包年包月
|网络类型|计费类型|实例占用费|宽带费|规格费|
|-|-|-|-|-|
|公网|按固定宽带计费|☑️|☑️|☑️|
|私网|按固定宽带计费|-|-|☑️|

## CLB按量计费
|网络类型|计费类型|实例占用费|流量费|宽带费|规格费|
|-|-|-|-|-|-|
|公网|按流量计费|☑️|☑️|-|☑️|
|公网|按宽带计费|☑️|-|☑️|☑️|
|私网|按流量计费|-|-|-|☑️|

## 计费方式转换操作API
|API|说明|
|-|-|
|ModifyLoadBalancerPayType|将按量计费实例转换为包看包月实例。|
|ModifyLoadBalancerInternetSpec|修改公网负载均衡实例的计费方式。|
|ModifyLoadBalancerInstanceChargeType|变更按量付费CLB实例的实例计费方式。|

# 报警
* 阿里云的负载均衡SLB的监控报警目前还不支持电话报警。开通云监控服务后，您可以在云监控控制台配置监控报警规则。云监控支持“短信”、“邮件”、“旺旺” 三种报警方式，暂不支持电话报警。

# 易错知识点
* SLB明确不支持经典网络的ECS和VPC的ECS混合挂载。
* PHP 知识超过 request_terminate_timeout时间返回502，超过fastcgi_read_timeout 返回504。
* 503（Service Temporarily Unavailable）暂时无法使用服务器，通常是由于流量超限或者后端服务器不可用。
可能原因：后端服务器直接返回503状态码，ALB透传后端状态码给客户端，请排查后端服务器返回503的原因。
* 502状态码错误提示表明负载均衡可以将来自客户端的请求转发到后端服务器，但是由于服务器中Web应用处理异常，导致出现该提示
# 负载均衡SLB服务地址访问超时
* 后端服务器accept队列满，导致后端服务器不回复syn_ack报文，客户端超时。这种情况下，由于后端服务器的accept队列已满，无法处理更多的连接请求，导致访问超时。
* SLB实例的服务地址被WAF安全防护。如果WAF误判了SLB实例的服务地址为恶意请求，它可能会阻止对该地址的访问，从而导致访问超时。
* rp_filter特性和负载均衡底层LVS的策略路由产生冲突，导致访问出现异常。这个问题可能会导致访问异常，但不一定会导致访问超时。
# ECS
## ECS基本概念
ECS实例等同于一台虚拟服务器，内含CPU、内存、操作系统、网络配置、磁盘等基础组件。

### 云服务ECS使用的限制
* 仅弹性裸金属服务器和超级计算集群支持二次虚拟化，其他规格不支持安装虚拟化软件和二次虚拟。
* 不支持声卡应用。
* 不支持直接加载外接设备，如硬件加密狗、U盘、外接硬件、银行Ukey等。
* 不支持多播协议。如果需要多播，建议改为使用单播点对点。
* 日志服务不支持32位Linux系统云服务器

### 保证ECS正常运行的注意事项
* 创建ECS实力后，您有实例的管理员权限，阿里云没有权限登入你的实力。
* 禁止使用ECS实例做流量穿透服务。
* 不要卸载相关硬件驱动。
* 不要随意修改网卡MAC地址。
* 建议不要开启SELinux。
* 建议将相关软件都设置成开机启动。如果应用服务连接数据库，需要在程序中设置成自动重连机制。
## 产品架构
* 实例：等同于一台虚拟服务器
* 镜像：装机盘
* 存储块：数据存储
* 快照：某一时间点云盘的实时副本
* 网络：专有网络vpc
* 安全组：虚拟防火墙
## 地域
数据中心所在的位置
## 可用区
统一地域内，电力和网络相互独立的物理区域
* 同一可用区内实例的网络延迟更小
* 同一地域内可用区之间使用低时延链路相连，内网互通
## 实例规格
### 入门级实例
一系列面向中小网站或个人的实力规格总称。

非绑定CPU调度模式。

实例规格族： 共享型，突发性能型

适用场景：轻量级Web应用程序，轻负载应用，微服务，开发测试压测服务应用

### 企业级实例
具有独享且稳定的计算，存储，网络资源，适合业务稳定性很高的场景。

固定CPU调度

实例规格族： 通用性，计算型，内存型，大数据型等

适用场景：大型多人游戏前端，数据分析和计算，中大型Web服务，高精度编解码，渲染，大数据处理加工
### 弹性裸金属服务器
保留了物理机的功能与特性，全面支持嵌套虚拟化技术。
它融合了物理机与云服务的优势，实现了超强超稳的计算能力，居然被物理机级别的完整处理器特性，以及物理机级别的资源隔离优势，特别适合上云部署传统非虚拟化场景的应用。
## 实例的生命周期与状态
## 创建实例的步骤
* 选择付费模式
* 选择地域及可用区，创建完成后不支持更改
* 实例规格
* 选择镜像
* 选择存储并配置，选择系统盘，可选数据盘或者共享盘NAS
* 可选配置快照服务

完成基础设置后，下一步，网络与安全组。

* 选择网络
* 可选择分配公网IP
* 选择安全组
* 配置弹性网卡
* 可选配置IPv6

## 镜像

ECS镜像是创建ECS实例的基础模板，它包含了启动和运行实例所需的操作系统和预配置数据。在创建ECS实例时必须选择一个镜像，该镜像可以是只包含系统盘的单个存储云盘，也可以是包含系统盘和一个或多个数据盘的组合。本文介绍镜像类型、费用以及如何选择镜像等其他信息

镜像就是云服务ECS的装机盘，为云服务ECS实例提供操作系统，初始化应用数据，预装软件。通过镜像可以创建并部署云服务ECS。

### 镜像类型
* 公共镜像
* 自定义镜像: 基于实例创建，基
于快照创建，使用SMC自动导入，通过OSS手动导入
* 共享镜像
* 镜像市场镜像
* 社区镜像

自定义镜像基于实例（系统盘）或者快照（需包含系统盘）创建镜像，或者从本地导入的镜像，包含已部署的应用、数据等信息。通过共享镜像（跨账号）、复制镜像（跨地域）等操作，可以方便复制ECS实例。

社区镜像不支持共享、导出与复制。

## 快照
* 某一时间点云盘数据状态的备份文件
* 实现高IO云盘的数据备份，保证业务处理的正确性和服务不中断。
* 创建快照可能会降低磁盘的性能，尽量避开业务高峰。
* 第一次全量，后续增量。自动保存在**独立于用自己的OSS Bucket**。
* 目前仅部分地域支持复制快照。
* 针对ESSD云盘，您可以通过快照极速可用（本地快照）功能加快创建快照的速度，实现秒级创建快照。

### 快照回滚
当云盘因误删误改、勒索病毒等原因造成数据丢失时，您可以使用该云盘的历史快照回滚云盘，从而使改云盘的数据恢复到创建快照时的状态。
有以下的限制：
* 您已经为云盘创建快照，而且要回滚的云盘当前没有正在创建的快照。（**不可逆，部分数据丢失**）。
* 云盘未被释放。
* 更换操作系统后，历史系统盘快照不能用于回滚新的系统盘。
* 云盘被用作创建动态扩展或RAID阵列时，您必须预先停止所有I/O操作，再使用快照回滚。
*云盘必须已经挂挂载到某台ECS实例上，而且已经**停止实例**。

## ECS实例在VPC下IP地址分类
### 私有IP地址
根据实例所属的VPC和虚拟交换机网段，**VPC类型实例已经创建即被分配一个私有IP地址**

私有IP地址可以用于以下场景：
* 负载均衡。
* 同一局域网内ECS实例之间内网互访。
* 同一局域网内ECS实例与其他云服务（如OSS、RDS）之间内防互访。

您可以根据业务需要，在ECS管理控制台上修改私有IP地址。

|  维度   | PublicIP  | EIP |
|  ----  | ----  |  ----   |
| 使用场景  | 如果希望创建ECS实例时由系统自动分配IP地址，释放实例时同这个公网IP地址实例一起释放，不保留公网IP | 长期使用某个公网IP地址，需要将它绑定到指定ECS实例。EIP可以反复绑定和解绑。释放实例后可以EIP存在 |
| 获取方式  | 创建实例时，选择了分配公网IPv4地址，即分配一个PublicIP | 单独申请EIP，并绑定到未分配PublicIP的ECS实例 |
| 分配上限  | 一台ECS实例只能分配一个 | 一台ECS实例可以关联多个EIP |
| 解绑方式 | 只能释放不能解绑。可以按需将PublicIP转换为EIP | 支持解绑
| 释放方式 | 释放实例时，PublicIP一起释放。将带宽值设置为0Mbit/s，可以释放PublicIP| 不需要EIP时可释放
| 查看MAC地址 | VPC类型的ECS实例的公网访问通过私有网卡的映射完成，实例内部都无法查询到公网网卡

### 公网IP地址
VPC类型实例支持两种公网IP地址
* ECS系统分配的公网地址（**PublicIP**）。
* 弹性公网IP地址 **EIP**。
## ECS实例在经典网络下IP地址分类
### 内网IP地址
每台经典网络ECS的实例一定会被分配一个IP地址用于内网的通信，这个IP地址被称为内网IP地址。

经典网络内IP地址不支持组播和广播。

经典网络内网IP地址不支持修改。

### 公网IP地址
如果您购买了公网带宽，即公网带宽不为0Mbit/s，阿里云会为实例分配一个公网IP。

不支持EIP。

经典网络公网IP转化为EIP后：
* 采用按使用流量计费方式。
* 公网宽带值与原ECS实例保持一致。0Mbit/s转化为EIP自动升级为1Mbit/s
* 不能挂载到EIP上。
* 经典网络类型ECS实例具有公网网卡。无法保留公网网卡和相应的Mac地址。

## IPv6
### 使用IPv6步骤
* 搭建IPv6 VPC
* 分配IPv6地址
* 开通IPv6公网带宽
* 配置IPv6地址
* 添加IPv6安全组规则
* 测试网络连通性
* （可选）删除IPv6地址

## IP地址的相关操作
### 修改专有网络私有IP地址
可以通过直接修改专有网络中ECS的私有IP，也可以通过更改实例所属的交换机来更改ECS实例的私有IP

前提条件
* 实例的弹性网卡未设置辅助私网IP地址。
* 实例处于**已停止状态***。
* 如果要更换交换机，需确保交换区的可用区与实例的可用区相同。实例需要重新启动后，修改的私有IP生效。

### 公网IP转化为弹性公网IP（经典网络）
* 按使用流量计费方式。
* 公网带宽值和原ECS实例保持一致。
* 不能挂载到经典网络类型ECS实例上。
* 无法保留改公网网卡和相应的Mac地址
## ECS 安全
### 安全组
安全组是云上的虚拟防火墙，它包含安全组规则和安全组内的云资源（虚拟机、弹性网卡等）。用户可以配置安全组规则来允许或拒绝指定类型的网络流量通行，还可以基于安全组划定安全域，通过授权安全组访问的能力，来实现云资源之间的访问控制。

安全组是一种虚拟防火墙，用于控制安全组内ECS实例的出入流量。安全组分为普通安全组和企业安全组，一台ECS实例最多可以加入**5**个安全组，初次创建ECS实例时会自动创建一个默认安全组，默认安全组是普通安全组。
### 安全组规则的构成
单条自定义的安全组规则，由以下信息构成：

* 协议类型：匹配流量的协议类型。支持TCP、UDP、ICMP(IPv4)、ICMP(IPv6)和GRE。

* 端口范围：匹配流量的目的端口。对于TCP和UDP协议，可以指定一个斜线（/）分隔的端口范围，比如8000/9000，或22/22。对其他协议，该字段取值-1/-1。更多信息，请参见常用端口。

* 授权对象：入方向规则中匹配流量的源地址，出方向规则中匹配流量的目的地址。支持CIDR地址块（或IP地址）、安全组、前缀列表三种类型。具体如下：IPv4地址：例如192.168.0.100。IPv4 CIDR地址块：例如192.168.0.0/24。IPv6地址：例如2408:4321:180:1701:94c7:bc38:3bfa:9。接口将会对IPv6地址进行标准化处理，比如，2408:180:0000::1将会被处理为2408:180::1。IPv6 CIDR地址块：例如2408:4321:180:1701::/64。接口将会对IPv6 CIDR地址块进行标准化处理，比如，2408:4321:180:0000::/64将会被处理为2408:4321:180::/64。

* 安全组ID：支持授权当前账号下或其他账号下的目标安全组，使用目标安全组中ECS实例的内网IP来进行流量匹配，实现内网访问的控制。例如，安全组A中有ECS实例b，当您授权安全组A访问时，您实际授权的是安全组A中ECS实例b的内网IP的访问权限。

* 前缀列表ID：前缀列表是一些网络前缀（即CIDR地址块）的集合。授权对象为前缀列表时，该条规则占用的安全组规则配额数量，为前缀列表最大条目数，与前缀列表中已有条目数量无关。更多信息，请参见前缀列表概述。

* 授权策略：允许或拒绝。在基于流量的协议、端口和授权对象匹配到某条安全组规则后，会对流量执行授权策略指定的动作，来允许或拒绝流量放行。

* 优先级：取值范围为1~100，数值越小，代表优先级越高。安全组规则的排序，首先考虑优先级，其次考虑授权策略，更多信息，请参见安全组规则排序策略。

* 规则方向：分为入方向和出方向，入方向规则控制入站流量，出方向规则控制出站流量。

* 规则ID：在您添加安全组规则时，系统会为每条安全组规则生成唯一的ID。若您需要修改或删除已有安全组规则，您可以通过安全组规则ID，来指定要进行操作的安全组规则。
### 安全组实践基本建议
* 白名单而不是黑名单，即默认拒绝所有访问。
* 最小授权原则。
* 不用类型应用使用不同的安全组。
* 尽可能保持单个安全组的规则简洁。
* 不要随便更新安全组的规则。
* 不需要公网访问的资源不提供公网IP。
* 避免直接修改线上环境使用的安全组。
* 合理定义安全组名称、标签等。
* 安全组可以跨可以用区。
* 设置安全组的时候，只设置内网规则。
### 安全组 vs ACL
| 安全组 | ACL |
|----|----|
| 实例级别 | 交换机级|
| 有状态 | 无状态，出入流量需分别设置 |
| 一个ECS实例可以加入多个安全组 | ECS所属的交换机只能绑定一个ACK |
| 三次访问控制 | 二层访问控制 |
## SSH密钥对
阿里云SSH密钥对是一种安全便捷的登录认证方式，用于在SSH协议中进行身份验证和加密通信。由公钥和私钥组成且仅支持Linux实例，满足您对更高安全性、便利性和自动化能力的业务需求。您可以直接在Windows环境和支持SSH命令的环境（例如Linux环境、Windows下的MobaXterm）中使用SSH密钥对连接Linux实例。

密钥对的安全强度远高于常规用户口令，可以杜绝暴力破解威胁。

便于远程登录大量Linux实例，方便管理。适合批量维护多台Linux实例。

使用时有以下限制：
* 如果使用SSH方式登入，则会禁用密码登入。
* 仅支持Linux实例。
* 一台Linux实例只能绑定一个密钥对。
* 实例状态运行中（Running）是绑定或解绑秘钥对，您需要重启实例使操作生效。
## 身份管理
为确保您的阿里云账号及云资源使用安全，如非必要都应避免直接使用阿里云账号（即主账号）来访问云服务器ECS。推荐的做法是使用RAM身份（即RAM用户和RAM角色）来访问云服务器ECS。
### RAM用户
阿里云的访问控制RAM（Resource Access Management）提供了强大的细粒度权限管理功能，适用于企业中多个部门或角色需要访问ECS资源的情况。为了保障敏感信息和关键业务流程的安全，您可以根据各部门或角色的具体职责分配不同的访问权限。通过实施权限分离策略，不仅能显著提升管理效率，还能有效降低信息泄露的风险。本文介绍如何通过控制RAM用户的权限，以实现对云服务器ECS资源的访问控制。

#### 场景介绍
假设您公司是使用ECS来托管应用程序和服务。其中，IT架构规划由管理人员主导，他们对所有ECS资源拥有控制权，包括但不限于创建资源、调整资源分配及安全策略配置等关键职责。开发人员负责项目的持续迭代和功能创新，并承担将项目部署到ECS上的任务。运维人员则承担起保障系统正常运转的责任，通过创建快照、创建镜像、执行相关脚本等方式维护现有服务。

针对这三类人员的需求，我们将设计如下权限方案：

管理人员：可以拥有创建、删除ECS实例及修改安全组规则等所有ECS操作权限。

开发人员：能够查看所有ECS实例的信息，但不能修改任何设置，同时可以登录ECS实例进行操作。

运维人员：具备创建部分资源的权限，但不具备删除资源的权限，如创建快照和镜像、执行脚本等任务。

### RAM用户组
当您的阿里云账号下有多个RAM用户时，可以通过创建用户组对职责相同的RAM用户进行分组管理和批量授权，实现高效地管理RAM用户及其权限。对于RAM用户组的使用，建议您：

在对RAM用户组授权时遵循最小权限策略原则。

在RAM用户职责发生变化时将其从不再归属的用户组中移除，避免权限滥用。

在某个用户组不再需要某些权限时移除用户组对应的权限。
### RAM角色
RAM角色是一种虚拟用户，可以被授予一组权限策略。与RAM用户不同，RAM角色没有永久身份凭证（登录密码或访问密钥），需要被一个可信实体扮演。扮演成功后，可信实体将获得RAM角色的临时身份凭证，即安全令牌（STS Token），使用该安全令牌就能以RAM角色身份访问被授权的资源。

#### 产品优势
* 使用STS Token，减少长期访问密钥泄露的分线
* STS Token具有时效性，可以自定义有效期，到期后自动失效，无效定期轮换。
* 可以为STS Token绑定自定义权限策略，提供更加灵活和精细的云资源授权。
## 基础安全服务
云服务器ECS提供了基础安全服务，包括异常登录检测、漏洞扫描、基线配置核查等。您可以在ECS控制台或者云安全中心看到您的云服务器安全状态。

提供5G以下DDos基础防护。

由**阿里云云安全中心**（Security Center）（云盾）提供云服务器ECS的基础安全服务，帮助您收集并呈现安全日志和云上资产指纹，主要提供免费版的漏洞检测、安全告警和基线检查服务。您可以在ECS管理控制台的概览页面或者云安全中心控制台查看相关安全信息。
### 计费说明
基础安全服务的计费说明如下：

云服务器ECS的基础安全服务为免费服务，不收取服务费用。

如果您需要升级为高级版或者企业版云安全中心，可以在云安全中心控制台免费试用或者购买服务。

## 实例启动模板
实例启动模板是一种用于快速创建实例的工具，其中包含了用于创建ECS实例的任意配置信息（**除实例密码**），包括**密钥对、RAM角色、实例类型和网络设置**等。每个模板可以有多个版本，每个版本可以配置不同的参数，您可以使用指定的模板的任意一个版本快速创建实例，提升效率及使用体验。实力启动模板不支持修改。

## 部署集
部署集是控制ECS实例分布的策略，使您能在创建ECS实例的时候就设计容灾能力和可用性。

针对追求高可用性的集群业务，可利用高可用或部署集组高可用策略，将ECS实例分散部署在不同的物理服务器上，以避免单点故障，提高业务的可用性；对于网络延迟高度敏感的应用（如高频交易、实时数据分析等），可利用网络低时延策略，将ECS实例集中部署到同一个网络拓扑范围内，缩短ECS实例间的网络通信延时。本文主要介绍部署集的部署策略、使用限制及如何使用部署集。

### 使用限制
* 部署集之间不支持相互合并。
* 部署集内不支持创建抢占式实例。
* 部署集不支持创建专有宿主机。
* 一个可用区最多创建20台ECS实例
* 不是所有规格都支持部署集。
* 在部署集内创建ECS实例时，或者重启按量付费ECS实例（节省停机模式）时，供货紧张任然会导致请求失败。

## 运维管理
### 系统事件
如果实例只挂载了云盘，可以选择：
* 自动重启恢复（默认）。
* 禁止重启恢复。

如果实例挂载了本地盘，可以选择：
* 自动重启恢复（默认）
* 禁止重启恢复
* 自动重新部署
### 运维知识
* 定期更新软补丁
* 网页本身内容大小、网络的宽带、是否有大量数据库的操作、是否引用过多其他网站的内容等操作会影响网站打开速度。
## 标签
标签可以识别资源和用户组别，允许企业或者个人将相同云服务器ECS资源归类。便于搜索和资源整合。
* 支持标签的服务：ECS实例、存储、快照、镜像、安全组等。
* 每个标签都由一对键值对（Key-Value）组成
* 每个实例最多可以绑定20个标签，每次最多绑定或解绑20个标签。
* 每个资源的任一标签的Key必须唯一，相同的Key会被覆盖。
* 不同地域中的标签信息不互通。

## 迁移
### 优势
* 支持多平台、多环境。
* 支持迁移不停机。
* 简单轻量且配置灵活。一键运行迁移后，全程自动托管。
* 数据传输安全有保证：默认采用SSL 2048位RSA密钥加密传输。

### 迁移数据库
数据传输服务，Data Tranmission Service，简称DTS，是阿里云提供的支持RDBMS、NoSQL、OLAP等数据库。

自建MySQL迁移至RDS MySQL实例的限制：
* DTS会尝试恢复七天之内迁移失任务。
* DTS支持结构迁移、全量数据迁移以及增量数据迁移。
* RDS MySQL实例的存储空间须大于自建MySQL数据库占用的存储空间。

## 多台ECS实例批量挂载同一NAS文件系统
仅支持Linux操作系统
仅支持运行中实例

## BGP机房优点
